---
output: 
  github_document:
    df_print: tibble
---

```{r setup, message = FALSE}
library(tidyverse)
library(readxl)
```
```{r}
download.file("https://zenodo.org/record/7814638/files/RAMLDB%20v4.61.zip?download=1", "fish.zip")
```
```{r}
unzip("fish.zip")
```

```{r}
mcatch<-read_csv("RAMCore/MCatch.csv")
mcatch
```
```{r}
xlsx<-"Excel/RAMLDB v4.61 (assessment data only).xlsx"
readxl::excel_sheets(xlsx)

ts1<-read_xlsx(xlsx, sheet="timeseries.1")
ts2<-read_xlsx(xlsx, sheet="timeseries.2")
area<- read_xlsx(xlsx, sheet= "area")
stock<- read_xlsx(xlsx, sheet= "stock")
metrics<- read_xlsx(xlsx, sheet= "tsmetrics")
metrics
assess<- read_xlsx(xlsx, sheet="assessment")

ts<-bind_rows(ts1, ts2) |> 
  distinct()|> 
  filter(tsid=="TCbest-MT")
```

```{r}
most_recent<-
  assess|>
  left_join(stock) |>
  filter(commonname=="Atlantic cod")|>
  filter(mostrecent==999)|>
  select(assessid)
most_recent
```

```{r}
units<-metrics |> 
  filter(tscategory=="CATCH or LANDINGS") |>
  filter(tsunitslong=="Metric tons")
units
```
```{r}
ts<-ts|> left_join(metrics, by=c("tsid"="tsunique"))
ts
```

```{r}
area |> 
  filter(country == "Canada") |>
  distinct(country, areacode)
```

```{r}
fish<- ts|> 
  left_join(metrics, by=c("tsid"="tsunique"))|>
  left_join(stock)|>
  left_join(area)
fish
```

We want to examine Atlantic cod, _Gadus mordhua_. 
```{r}
cod <- fish |> 
  filter(scientificname == "Gadus morhua") |>
  filter(country == "Canada") |>
  inner_join(most_recent, by = "assessid") 
cod
```
#Filtering data by "stockid"
```{r}
cod_2J3KL <- fish |>
  filter(scientificname == "Gadus morhua") |>
  filter(stockid == "COD2J3KL") |>
  filter(areaid == "Canada-DFO-2J3KL") |>
  inner_join(most_recent, by = "assessid")
cod_2J3KL
```
#Determining which Canadian cod stocks are considered collapsed
```{r}
collapse<-cod_2J3KL |> 
  select(tsyear, tsvalue, stockid, areaid) |>
  mutate(collapsed = tsvalue < 0.1*max(tsvalue, na.rm=TRUE))
collapse
```
#Filtering the data by "areaname" instead of "stockid"
```{r}
cod |>
  filter(scientificname == "Gadus morhua") |>
  filter(areaname == "Southern Labrador-Eastern Newfoundland") |>
  inner_join(most_recent, by = "assessid") |>
  group_by(tsyear) |>
  summarise(total = sum(tsvalue, na.rm = TRUE)) |>
  ggplot(mapping=aes(tsyear, total)) + geom_point() + geom_line()
```
```{r}
#Not sure what this chunk does. Delete?
mea_cod <- cod |>
  filter(assessid == "DFO-NFLD-COD2J3KL-1850-2011-CHING")
```


# Unit 2: Fisheries Collapse Module

This module will focus on understanding and replicating fisheries stock assessment data and fisheries collapse.

Instead of working with independent data.frames, we will be working with a large relational database which contains many different tables of different sizes and shapes, but that all all related to each other through a series of different ids.

## The Database

We will use data from the [RAM Legacy Stock Assessment Database](https://www.ramlegacy.org/database/)

# Exercise 1: Investigating the North-Atlantic Cod

Now we are ready to dive into our data. First, We seek to replicate the following figure from the Millennium Ecosystem Assessment Project using the RAM data.

![](http://espm-157.carlboettiger.info/img/cod.jpg)
```

------------------------------------------------------------------------

# Exercise 2: Group Assignment

## Stock Collapses

We seek to replicate the temporal trend in stock declines shown in [Worm et al 2006](http://doi.org/10.1126/science.1132294):

![](http://espm-157.carlboettiger.info/img/worm2006.jpg)

```
```{r}
total_cod <- fish |> 
  filter(scientificname == "Gadus morhua") |>
  filter(country == "Canada") |>
  inner_join(most_recent, by = "assessid") 
total_cod
```

```{r}
total_cod=total_cod |> 
  group_by(stockid)|>
  group_by(tsyear)|>
  mutate(collapsed=tsvalue<0.10* max(tsvalue, na.rm=TRUE))
```
```{r}
total_cod|>
  filter(collapsed==TRUE)|>
  ggplot(aes(x = tsyear, y = collapsed)) + geom_point()
total_cod
#Use taxa as species
#group by species and then sort by collapsed (true/false)
# calculate collapse value per stock 
```
#Notes
Find lowest common denominator of stocks in the earliest year 
Denominator could be total number of stocks reported in study (look at paper on course website)- percentage of what total number of stocks 
  #find total number of stocks collapsed by year first
true is also equal to 1, false is equal to zero
if true then plot it

#All species
```{r}
all_species <- fish |>
  filter(tsid == "TCbest-MT") |>
  group_by(tsyear,scientificname) |>
  summarise(total_catch = sum(tsvalue, na.rm = TRUE)) |>
  group_by(scientificname) |>
  mutate(historical_max = max(total_catch), #historical maximum of catch 
        is_collapse = total_catch < 0.1 * historical_max, ever_collapse = cumsum(is_collapse) > 0)
all_species
```

#1950-2020
```{r}
time_span <- 1950:2020


recent_data <- nrow(all_species %>%
                      #group_by(scientificname, tsyear) |>
                      filter(tsyear %in% time_span) |>
                      #group_by(scientificname) |>
                      count() |>
                      filter(recent_data == length(time_span)))
recent_data
#how many years each species is observed
recent_data<-nrow(all_species|>
                    filter(tsyear %in% time_span)|>
                    group_by(scientificname)|>
                    count())
```
```{r}

```

#calculate cumulative number of stocks collapsed (ie show number of collapsed stocks by 1960, instead of number of stocks colapsed in each year)

#Assessing multiple species data
```{r}
recent_species<-
  assess|>
  left_join(stock) |>
  filter(mostrecent==999)|>
  select(assessid)
recent_species
```
Total species count table
```{r}
all_species_prop<-all_species|>
  filter(tsyear %in% time_span)|>
  group_by(tsyear)|>
  summarise(collapse=sum(is_collapse),
            cumu_collapsed/recent_data)|>
  select(tsyear, )
 mutate(collapsed=tsvalue<0.10* max(tsvalue, na.rm=TRUE))
all_species
```
Create a new column that assigns a numeric value to TRUE or FALSE from collapse column. Plot data based on these values (1 or 0). 
```{r}

all_species=all_species|>
 mutate(collapsed_value=ifelse(collapsed=="TRUE", 1, 0))
  
  


#group_by(tsyear)|>
  #summarize(sum=sum(collapsed_value, na.rm=TRUE))
all_species


 # mutate(collapsed_value=ifelse(collapsed==TRUE, 1, 0))
#calculate number of one values per year
```

```

